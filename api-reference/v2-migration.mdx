---
title: "V2 API Migration Guide"
description: "Guide to migrating from V1 to V2 API endpoints"
---

## Overview

The Fibrous Router API V2 introduces enhanced features and improved response structure while maintaining backward compatibility with V1 endpoints. This guide will help you migrate your integration to take advantage of V2 features.

## What's New in V2

<CardGroup cols={2}>
  <Card title="Integrator Features" icon="users">
    Support for integrator fees and surplus sharing to monetize your integration
  </Card>
  
  <Card title="Enhanced Metadata" icon="info">
    All responses include API version and timestamp for better tracking
  </Card>
  
  <Card title="Route and Calldata" icon="bolt">
    New GET endpoint to get route and calldata in a single request
  </Card>
  
  <Card title="Improved Structure" icon="code">
    Better organized response format with consistent meta fields
  </Card>
</CardGroup>

## Key Differences

### Response Structure

**V1 Response:**
```json
{
  "success": true,
  "inputToken": {...},
  "outputToken": {...},
  "outputAmount": "1000000000"
}
```

**V2 Response:**
```json
{
  "success": true,
  "inputToken": {...},
  "outputToken": {...},
  "outputAmount": "1000000000",
  "outputAmountAfterFee": "995000000",
  "meta": {
    "apiVersion": "2.0",
    "timestamp": "2024-01-15T10:30:00.000Z"
  }
}
```

### New Endpoints

V2 introduces a new endpoint that combines route finding and calldata generation:

- **GET `/monad/v2/routeAndCallData`** - Get route and calldata in one request

### Integrator Features

V2 supports monetization through integrator fees or surplus sharing:

- **Integrator Fee**: Charge a percentage (0-5%) on swaps routed through your integration
- **Integrator Surplus**: Share in surplus value (0-50%) when routing finds better prices
- **Note**: You cannot use both fee and surplus in the same request

## Migration Steps

### Step 1: Update Base URL

Change your base URL from:
```bash
https://api.fibrous.finance/monad
```

To:
```bash
https://api.fibrous.finance/monad/v2
```

### Step 2: Handle Meta Field

All V2 responses include a `meta` field. Update your response handling:

```javascript
// V1
const { success, outputAmount } = response;

// V2
const { success, outputAmount, meta } = response;
console.log(`API Version: ${meta.apiVersion}`);
console.log(`Response Time: ${meta.timestamp}`);
```

### Step 3: Update Route Endpoint

**V1:**
```javascript
GET /monad/route?amount=1000&tokenInAddress=0x...&tokenOutAddress=0x...
```

**V2:**
```javascript
GET /monad/v2/route?amount=1000&tokenInAddress=0x...&tokenOutAddress=0x...
```

Optional integrator parameters:
```javascript
GET /monad/v2/route?amount=1000&tokenInAddress=0x...&tokenOutAddress=0x...&integratorAddress=0x...&integratorFeePercentageBps=100
```

### Step 4: Use New Route and Calldata Endpoint

Instead of making two separate calls:

**V1 (2 calls):**
```javascript
// 1. Get route
const route = await fetch('/monad/route?...');

// 2. Get calldata
const calldata = await fetch('/monad/calldata?...');
```

**V2 (1 call):**
```javascript
// Get route and calldata in one call
const response = await fetch('/monad/v2/routeAndCallData?amount=1000&tokenInAddress=0x...&tokenOutAddress=0x...&slippage=0.5&destination=0x...');
const { route, calldata, router_address, meta } = await response.json();
```

### Step 5: Update Calldata Endpoint

**V1:**
```javascript
GET /monad/calldata?amount=1000&tokenInAddress=0x...&tokenOutAddress=0x...&slippage=0.5&destination=0x...
```

**V2:**
```javascript
POST /monad/v2/calldata
Body: {
  "route": {...},
  "slippage": 0.5,
  "destination": "0x...",
  "integratorAddress": "0x...", // optional
  "integratorFeePercentageBps": 100 // optional
}
```

### Step 6: Handle Integrator Features (Optional)

If you want to monetize your integration:

```javascript
// Set up API key authentication
const headers = {
  'X-API-Key': 'your-api-key-here'
};

// Use integrator fee
const response = await fetch('/monad/v2/route', {
  headers,
  params: {
    amount: '1000',
    tokenInAddress: '0x...',
    tokenOutAddress: '0x...',
    integratorAddress: '0xYourWallet',
    integratorFeePercentageBps: 100 // 1% fee
  }
});

// Response includes outputAmountAfterFee
const { outputAmount, outputAmountAfterFee, integratorFeePercentageBps } = response;
```

## Parameter Changes

### New Optional Parameters

All V2 endpoints support these optional integrator parameters:

| Parameter | Type | Description |
|-----------|------|-------------|
| `integratorAddress` | string | Wallet address to receive fees/surplus |
| `integratorFeePercentageBps` | number | Fee percentage in basis points (0-500, max 5%) |
| `integratorSurplusPercentageBps` | number | Surplus percentage in basis points (0-5000, max 50%) |

<Warning>
You cannot use both `integratorFeePercentageBps` and `integratorSurplusPercentageBps` in the same request.
</Warning>

### Response Field Changes

| Field | V1 | V2 | Notes |
|-------|----|----|-------|
| `meta` | ❌ | ✅ | Always present in V2 |
| `outputAmountAfterFee` | ❌ | ✅ | Present when integrator fee is used |
| `integratorAddress` | ❌ | ✅ | Present when integrator features are used |
| `integratorFeePercentageBps` | ❌ | ✅ | Present when integrator fee is set |
| `integratorSurplusPercentageBps` | ❌ | ✅ | Present when integrator surplus is set |
| `integratorName` | ❌ | ✅ | Present when API key is used |

## Code Examples

### Complete Migration Example

```javascript
// V1 Implementation
async function swapV1(amount, tokenIn, tokenOut, slippage, destination) {
  // Step 1: Get route
  const routeResponse = await fetch(
    `https://api.fibrous.finance/monad/route?amount=${amount}&tokenInAddress=${tokenIn}&tokenOutAddress=${tokenOut}`
  );
  const route = await routeResponse.json();
  
  // Step 2: Get calldata
  const calldataResponse = await fetch(
    `https://api.fibrous.finance/monad/calldata?amount=${amount}&tokenInAddress=${tokenIn}&tokenOutAddress=${tokenOut}&slippage=${slippage}&destination=${destination}`
  );
  const calldata = await calldataResponse.json();
  
  return { route, calldata };
}

// V2 Implementation
async function swapV2(amount, tokenIn, tokenOut, slippage, destination, apiKey = null) {
  const headers = apiKey ? { 'X-API-Key': apiKey } : {};
  
  // Single call to get route and calldata
  const response = await fetch(
    `https://api.fibrous.finance/monad/v2/routeAndCallData?amount=${amount}&tokenInAddress=${tokenIn}&tokenOutAddress=${tokenOut}&slippage=${slippage}&destination=${destination}`,
    { headers }
  );
  
  const data = await response.json();
  
  // Log API version for debugging
  console.log(`Using API ${data.meta.apiVersion} at ${data.meta.timestamp}`);
  
  return {
    route: data.route,
    calldata: data.calldata,
    routerAddress: data.router_address,
    meta: data.meta
  };
}
```

### With Integrator Features

```javascript
async function swapWithIntegratorFee(amount, tokenIn, tokenOut, slippage, destination, apiKey, integratorAddress) {
  const headers = { 'X-API-Key': apiKey };
  
  const params = new URLSearchParams({
    amount,
    tokenInAddress: tokenIn,
    tokenOutAddress: tokenOut,
    slippage,
    destination,
    integratorAddress,
    integratorFeePercentageBps: '100' // 1% fee
  });
  
  const response = await fetch(
    `https://api.fibrous.finance/monad/v2/route?${params}`,
    { headers }
  );
  
  const data = await response.json();
  
  // Show user the amount after fee
  const amountAfterFee = data.outputAmountAfterFee;
  const feeAmount = BigInt(data.outputAmount) - BigInt(amountAfterFee);
  
  console.log(`Output: ${data.outputAmount}`);
  console.log(`After ${data.integratorFeePercentageBps / 100}% fee: ${amountAfterFee}`);
  console.log(`Fee earned: ${feeAmount}`);
  
  return data;
}
```

## Backward Compatibility

<Info>
V1 endpoints remain available and fully functional. You can migrate at your own pace without breaking existing integrations.
</Info>

- V1 endpoints: `https://api.fibrous.finance/monad/*`
- V2 endpoints: `https://api.fibrous.finance/monad/v2/*`

Both versions will continue to be supported, but we recommend migrating to V2 to take advantage of new features.

## Testing Your Migration

1. **Test with small amounts first**
   - Verify responses match expected format
   - Check that meta fields are present
   - Validate integrator features if used

2. **Monitor API version in responses**
   - Log `meta.apiVersion` to ensure you're using V2
   - Track `meta.timestamp` for debugging

3. **Verify integrator features**
   - Test with API key authentication
   - Verify fee calculations
   - Check outputAmountAfterFee values

## Common Issues

### Issue: Missing Meta Field

**Problem:** Response doesn't include `meta` field

**Solution:** Ensure you're using `/monad/v2/*` endpoints, not `/monad/*`

### Issue: Integrator Features Not Working

**Problem:** Integrator parameters are ignored

**Solution:** 
- Verify API key is included in request headers
- Check that integrator address is valid
- Ensure only one of fee or surplus is set

### Issue: Route and Calldata Endpoint Returns 404

**Problem:** `/monad/v2/routeAndCallData` not found

**Solution:** This endpoint is V2-only. Use `/monad/v2/routeAndCallData` (not `/monad/routeAndCallData`)

## Next Steps

- Review [V2 Route Endpoint](/api-reference/endpoints/route-v2) documentation
- Check [V2 Calldata Endpoint](/api-reference/endpoints/calldata-v2) for POST endpoint details
- Explore [Integrator Features](/api-reference/v2-migration#integrator-features) for monetization

## Support

If you encounter issues during migration:

- Check our [FAQ](/essentials/faq)
- Join our [Discord](https://discord.gg/fibrous) for community support
- Contact us at [contact@fibrous.finance](mailto:contact@fibrous.finance)

